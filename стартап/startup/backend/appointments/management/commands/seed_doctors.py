"""
Management command: python manage.py seed_doctors

Populates the Doctor table with realistic data for every hospital.
Safe to re-run — skips hospitals that already have doctors.
"""

from django.core.management.base import BaseCommand
from appointments.models import Hospital, Doctor

# ---------------------------------------------------------------------------
# Doctor pools per specialty (name lists rotate over hospitals)
# ---------------------------------------------------------------------------

DOCTORS_BY_SPECIALTY = {
    'Терапевт': [
        ('Иванова Марина Сергеевна',    '101', 'Пн–Пт', '08:00–16:00'),
        ('Петров Андрей Николаевич',     '102', 'Пн–Пт', '09:00–17:00'),
        ('Смирнова Ольга Викторовна',    '103', 'Вт–Сб', '08:00–16:00'),
        ('Козлов Дмитрий Алексеевич',   '104', 'Пн–Пт', '10:00–18:00'),
        ('Новикова Татьяна Ивановна',    '105', 'Пн–Пт', '08:00–16:00'),
        ('Морозов Сергей Павлович',      '106', 'Пн–Сб', '09:00–17:00'),
        ('Федорова Елена Юрьевна',       '107', 'Пн–Пт', '08:00–14:00'),
        ('Волков Игорь Константинович',  '108', 'Вт–Сб', '10:00–18:00'),
    ],
    'Хирург': [
        ('Соколов Виктор Михайлович',    '201', 'Пн–Пт', '08:00–16:00'),
        ('Лебедева Наталья Олеговна',    '202', 'Пн–Сб', '09:00–17:00'),
        ('Новиков Александр Борисович',  '203', 'Пн–Пт', '08:00–15:00'),
        ('Козлова Ирина Сергеевна',      '204', 'Вт–Сб', '09:00–17:00'),
        ('Попов Николай Дмитриевич',     '205', 'Пн–Пт', '07:00–15:00'),
    ],
    'Стоматолог': [
        ('Кузнецова Алина Владимировна', '301', 'Пн–Пт', '09:00–18:00'),
        ('Орлов Павел Романович',        '302', 'Пн–Сб', '08:00–17:00'),
        ('Ершова Светлана Игоревна',     '303', 'Пн–Пт', '10:00–19:00'),
        ('Белов Артём Геннадьевич',      '304', 'Пн–Сб', '09:00–18:00'),
        ('Тихонова Валерия Андреевна',   '305', 'Вт–Сб', '09:00–18:00'),
        ('Медведев Олег Николаевич',     '306', 'Пн–Пт', '08:00–16:00'),
    ],
    'Педиатр': [
        ('Захарова Нина Петровна',       '401', 'Пн–Пт', '08:00–16:00'),
        ('Воробьёв Максим Сергеевич',    '402', 'Пн–Пт', '09:00–17:00'),
        ('Степанова Юлия Витальевна',    '403', 'Вт–Сб', '08:00–16:00'),
        ('Громов Илья Анатольевич',      '404', 'Пн–Пт', '10:00–18:00'),
        ('Мельникова Диана Сергеевна',   '405', 'Пн–Сб', '08:00–16:00'),
    ],
    'Кардиолог': [
        ('Яковлева Ирина Петровна',      '501', 'Пн–Пт', '09:00–16:00'),
        ('Данилов Андрей Викторович',    '502', 'Пн–Пт', '08:00–15:00'),
        ('Фролова Светлана Борисовна',   '503', 'Вт–Сб', '09:00–16:00'),
        ('Алексеев Константин Романович','504', 'Пн–Пт', '10:00–17:00'),
    ],
    'Невролог': [
        ('Борисова Анастасия Игоревна',  '601', 'Пн–Пт', '09:00–17:00'),
        ('Тимофеев Евгений Павлович',    '602', 'Пн–Пт', '08:00–15:00'),
        ('Романова Дарья Александровна', '603', 'Вт–Сб', '10:00–18:00'),
        ('Сергеев Виталий Андреевич',    '604', 'Пн–Пт', '09:00–16:00'),
    ],
    'Офтальмолог': [
        ('Никитина Екатерина Олеговна',  '701', 'Пн–Пт', '09:00–16:00'),
        ('Матвеев Сергей Александрович', '702', 'Пн–Сб', '08:00–16:00'),
        ('Осипова Вера Николаевна',      '703', 'Вт–Пт', '10:00–18:00'),
    ],
    'Дерматолог': [
        ('Кириллова Мария Фёдоровна',    '801', 'Пн–Пт', '09:00–16:00'),
        ('Беляев Антон Сергеевич',       '802', 'Пн–Сб', '10:00–18:00'),
        ('Власова Людмила Викторовна',   '803', 'Вт–Сб', '08:00–16:00'),
    ],
    'Эндокринолог': [
        ('Пономарёва Галина Ивановна',   '901', 'Пн–Пт', '09:00–16:00'),
        ('Крылов Денис Олегович',        '902', 'Вт–Сб', '08:00–15:00'),
        ('Зайцева Марина Анатольевна',   '903', 'Пн–Пт', '10:00–17:00'),
    ],
    'Гинеколог': [
        ('Ковалёва Надежда Петровна',    '1001', 'Пн–Пт', '08:00–16:00'),
        ('Лазарева Оксана Михайловна',   '1002', 'Пн–Сб', '09:00–17:00'),
        ('Миронова Юлия Сергеевна',      '1003', 'Вт–Сб', '10:00–18:00'),
    ],
    'Уролог': [
        ('Голубев Роман Алексеевич',     '1101', 'Пн–Пт', '09:00–16:00'),
        ('Куликов Степан Андреевич',     '1102', 'Вт–Сб', '08:00–15:00'),
    ],
    'Психиатр': [
        ('Щербакова Валентина Юрьевна',  '1201', 'Пн–Пт', '09:00–16:00'),
        ('Меньшов Игорь Борисович',      '1202', 'Вт–Сб', '10:00–17:00'),
    ],
}

# ---------------------------------------------------------------------------
# Spec sets per hospital type (keyword → list of specialties)
# ---------------------------------------------------------------------------

# (keyword_in_name, [specialties, ...], num_doctors_each)
HOSPITAL_PROFILES = [
    # Городские клинические больницы — полный профиль
    ('Городская клиническая больница',
     ['Терапевт', 'Хирург', 'Кардиолог', 'Невролог', 'Офтальмолог',
      'Гинеколог', 'Уролог', 'Дерматолог', 'Эндокринолог'], 2),

    # Центральная городская клиническая больница
    ('Центральная городская клиническая',
     ['Терапевт', 'Хирург', 'Кардиолог', 'Невролог', 'Офтальмолог',
      'Гинеколог', 'Уролог', 'Эндокринолог', 'Психиатр'], 2),

    # БСМП — акцент на хирургии
    ('скорой медицинской помощи',
     ['Хирург', 'Терапевт', 'Кардиолог', 'Невролог'], 2),

    # Областная больница — широкий профиль
    ('Областная больница',
     ['Терапевт', 'Хирург', 'Кардиолог', 'Невролог', 'Офтальмолог',
      'Гинеколог', 'Уролог', 'Дерматолог', 'Эндокринолог', 'Психиатр'], 2),

    # Городские поликлиники — базовый взрослый набор
    ('Городская поликлиника',
     ['Терапевт', 'Кардиолог', 'Невролог', 'Офтальмолог', 'Дерматолог', 'Эндокринолог'], 2),

    # Детские поликлиники
    ('Детская поликлиника', ['Педиатр', 'Невролог', 'Офтальмолог'], 2),

    # Стоматологические
    ('Стоматологическая', ['Стоматолог'], 3),

    # Кожно-венерологический диспансер
    ('Кожно-венерологический', ['Дерматолог'], 3),

    # Противотуберкулёзный диспансер
    ('Противотуберкулезный', ['Терапевт'], 2),

    # Поликлиника ветеранов
    ('поликлиника ветеранов',
     ['Терапевт', 'Кардиолог', 'Невролог', 'Офтальмолог', 'Эндокринолог'], 2),

    # Частные клиники — широкий профиль
    ('Клиника', ['Терапевт', 'Кардиолог', 'Невролог', 'Гинеколог',
                 'Дерматолог', 'Офтальмолог', 'Эндокринолог', 'Уролог'], 2),

    # Медицинские центры
    ('Медицинский центр', ['Терапевт', 'Кардиолог', 'Невролог',
                           'Гинеколог', 'Дерматолог', 'Уролог'], 2),
]


def get_profile(hospital_name):
    """Return (specialties, count) for the given hospital name."""
    for keyword, specs, count in HOSPITAL_PROFILES:
        if keyword.lower() in hospital_name.lower():
            return specs, count
    # fallback
    return ['Терапевт', 'Дерматолог', 'Невролог'], 1


class Command(BaseCommand):
    help = 'Seed the Doctor table with realistic sample data'

    def add_arguments(self, parser):
        parser.add_argument(
            '--force',
            action='store_true',
            help='Re-seed even if doctors already exist for a hospital',
        )

    def handle(self, *args, **options):
        force = options['force']
        total_created = 0

        hospitals = Hospital.objects.all().order_by('name')

        # Index pointers so we rotate through doctor name lists
        pointers = {spec: 0 for spec in DOCTORS_BY_SPECIALTY}

        for hospital in hospitals:
            existing = Doctor.objects.filter(hospital=hospital).count()
            if existing and not force:
                self.stdout.write(f'  skip  {hospital.name} (уже {existing} врачей)')
                continue

            specs, count = get_profile(hospital.name)
            created = 0

            for spec in specs:
                pool = DOCTORS_BY_SPECIALTY.get(spec, [])
                if not pool:
                    continue

                for _ in range(count):
                    idx = pointers[spec] % len(pool)
                    name, cab, days, hours = pool[idx]
                    pointers[spec] += 1

                    Doctor.objects.get_or_create(
                        hospital=hospital,
                        full_name=name,
                        specialty=spec,
                        defaults=dict(
                            cabinet=cab,
                            work_days=days,
                            work_hours=hours,
                            is_active=True,
                        )
                    )
                    created += 1

            total_created += created
            self.stdout.write(self.style.SUCCESS(
                f'  ✓  {hospital.name}  →  {created} врачей'
            ))

        self.stdout.write(self.style.SUCCESS(
            f'\nГотово! Всего добавлено: {total_created} врачей.'
        ))
